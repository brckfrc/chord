# Chord E2E Test Environment
# Docker Compose configuration for Playwright E2E tests
#
# Purpose: Isolated test environment with fresh database on each run
# Usage: docker compose -f docker-compose.test.yml up -d
#
# Key differences from production:
# - No persistent volumes (fresh state each run)
# - Exposed ports for Playwright access (API: 5049, Frontend: 5173)
# - Test-specific environment variables
# - No LiveKit/Coturn (not needed for basic flow tests)
# - Built from source (not from images)

services:
  # ===========================================
  # INFRASTRUCTURE
  # ===========================================
  
  sqlserver-test:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: chord-sqlserver-test
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${SQL_SA_PASSWORD:-TestPassword123!}"
      MSSQL_PID: "Developer"
    # No ports exposed (internal only, like YunoHost)
    # No volumes (fresh DB each run)
    networks:
      chord-test-network:
        aliases:
          - sqlserver
          - chord-sqlserver
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$SA_PASSWORD\" -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  redis-test:
    image: redis:7-alpine
    container_name: chord-redis-test
    # No ports exposed (internal only, like YunoHost)
    # No volumes (fresh state each run)
    networks:
      chord-test-network:
        aliases:
          - redis
          - chord-redis
    command: redis-server --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  minio-test:
    image: minio/minio:latest
    container_name: chord-minio-test
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin123}"
    ports:
      - "9000:9000"
      - "9001:9001"
    # No volumes (fresh state each run)
    networks:
      - chord-test-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================
  # BACKEND API
  # ===========================================
  
  api-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: chord-api-test
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - SQL_SA_PASSWORD=${SQL_SA_PASSWORD:-TestPassword123!}
      - SQL_SERVER_HOST=sqlserver
      - SQL_SERVER_PORT=1433
      - DATABASE_NAME=${DATABASE_NAME:-ChordDB_Test}
      - JWT_SECRET=${JWT_SECRET:-TestJWTSecretKeyForE2ETests12345678901234567890}
      - JWT_ISSUER=${JWT_ISSUER:-ChordAPI}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-ChordClient}
      - JWT_EXPIRY_MINUTES=${JWT_EXPIRY_MINUTES:-60}
      - JWT_REFRESH_TOKEN_EXPIRY_DAYS=${JWT_REFRESH_TOKEN_EXPIRY_DAYS:-7}
      - CORS_ORIGINS=http://localhost:5173
      - REDIS_CONNECTION=redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin123}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME:-chord-uploads}
      - MINIO_USE_SSL=false
      - MINIO_PUBLIC_ENDPOINT=http://localhost:9000
    ports:
      - "5049:80"
    networks:
      - chord-test-network
    depends_on:
      sqlserver-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      minio-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  # ===========================================
  # FRONTEND
  # ===========================================
  
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=http://localhost:5049/api
        - VITE_SIGNALR_BASE_URL=http://localhost:5049
    container_name: chord-frontend-test
    ports:
      - "5173:80"
    networks:
      - chord-test-network
    depends_on:
      api-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  chord-test-network:
    driver: bridge
